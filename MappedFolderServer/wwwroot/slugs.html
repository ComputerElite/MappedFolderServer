<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/assets/style.css">
    <title>Management</title>
    <script src="/assets/awesomplete.min.js"></script>
</head>
<body>
    <h1>Me</h1>
    <div id="me">
        Loading
    </div>
    <h1>Slugs</h1>
    <table id="slugs">
        
    </table>
    <button onclick="newSlug()">New Slug</button>
    <button onclick="newSlug(true)">New Slug from git</button>
    <h1>Remote Open Entries</h1>
    <table id="remoteOpens">
        
    </table>
    <button onclick="newRemoteOpen()">New Remote Open</button>
    <h1>Folder Claims</h1>
    <table id="folderClaims">

    </table>
    <button onclick="newFolderClaim()" class="adminOnly hidden">New Folder Claim</button>
    <div class="hidden" id="usersWrapper">
        <h1>users</h1>
        <table id="users">

        </table>
    </div>

    <div class="popup hidden" id="remoteOpenChooserPopup">
        <div class="popup-content">
            <h2>Remote open <span id="remoteOpenChooserSlugName"></span></h2>
            <h3>Options</h3>
            <label>Path: <input type="text" onkeyUp="updatePaths()" class="awesomplete" autocomplete="off" placeholder="the path to open" id="remoteChooserPath"></label>
            <h3>Input remote id...</h3>
            <label>Remote id: <input type="text" id="remoteChooserId"></label>
            <button onclick="setRemoteOpen(document.getElementById('remoteChooserId').value, currently_editing.id); closePopup('remoteOpenChooserPopup');">Open on remote</button>
            <br>
            <h3>...or set RemoteOpen</h3>
            <table id="remoteOpenChooserTable">
                
            </table>
            <button onclick="closePopup('remoteOpenChooserPopup')">Cancel</button>
        </div>
    </div>

    <div class="popup hidden" id="remoteOpenPopup">
        <div class="popup-content">
            <h3>RemoteOpen created</h3>
            <p>Copy the link and save it or download the html. You cannot view it again without regenerating the secret.</p>
            <button onclick="copyLink()">Copy link</button>
            <button onclick="downloadHtml()">Download html</button>
            <br>
            <br>
            <button onclick="closePopup('remoteOpenPopup')">Close</button>
        </div>
    </div>

    <div class="popup hidden" id="folderClaimPopup">
        <div class="popup-content">
            <table>
                <tr>
                    <td>Folder path</td><td><input type="text" id="folderClaim-folder"></td>
                </tr>
                <tr>
                    <td>userid</td><td><input id="folderClaim-userid" type="text"></td>
                </tr>
                <tr>
                    <td class="whenExisting"><button onclick="saveFolderClaim()">Save</button></td>
                    <td class="whenNew"><button onclick="createFolderClaim()">Create</button></td>
                    <td><button onclick="closePopup('folderClaimPopup')">Cancel</button></td>
                </tr>
            </table>
            
            
            
            <div class="whenExisting">
                <br>
                <br>
                <tr>
                    <td>
                        <button onclick="deleteFolderClaim()" class="dangerous">Delete</button>
                    </td>
                </tr>
            </div>

        </div>
    </div>
    
    <div class="popup hidden" id="slugPopup">
        <div class="popup-content">
            <table>
                <tr class="whenExisting">
                    <td>Slug</td><td><input id="slug-name" type="text"></td>
                </tr>
                <tr>
                    <td>Folder</td><td><input type="text" onkeyUp="updateSlugPaths()" class="awesomplete" autocomplete="off" placeholder="the path to open" id="slug-folder"></td>
                </tr>
                <tr>
                    <td>Make Public</td><td><input id="slug-public" type="checkbox"></td>
                </tr>
                <tr class="whenGit">
                    <td>Git url</td><td><input id="slug-git-url" type="text"></td>
                </tr>
                <tr class="whenGit">
                    <td>branch</td><td><input id="slug-git-branch" value="main" type="text"></td>
                </tr>
                <tr class="whenGit">
                    <td>Username (if private)</td><td><input id="slug-git-username" type="text"></td>
                </tr>
                <tr class="whenGit">
                    <td>Password (if private)</td><td><input id="slug-git-password" type="password"></td>
                </tr>
            </table>
            <table>
                <tr>
                    <td class="whenExisting"><button onclick="saveSlug()">Save</button></td>
                    <td class="whenNew"><button onclick="createSlug(this)">Create</button></td>
                    <td><button onclick="closePopup('slugPopup')">Cancel</button></td>
                </tr>
            </table>
            <div class="whenExisting">
                <br><br>
                <table>
                    <tr>
                        <td>New Password</td>
                        <td><input type="password" placeholder="new password" id="newPassword"></td>
                    </tr>
                    <tr>
                        <td>Confirm Password</td>
                        <td><input type="password" placeholder="confirm new password" id="newPasswordConfirm"></td>
                    </tr>
                    <tr>
                        <td><button onclick="changePassword()">Change password</button></td>
                        <td><button onclick="deletePassword()">Clear password</button></td>
                    </tr>
                    <tr>
                        <td>
                            <button class="dangerous" onclick="deleteSlug()">Delete</button>
                        </td>
                    </tr>
                </table>
            </div>
            
        </div>
    </div>
    <script src="/assets/common.js"></script>
    <script>
        const slugs = document.getElementById('slugs')
        const slugName = document.getElementById('slug-name')
        const slugFolder = document.getElementById('slug-folder')
        const slugPublic = document.getElementById('slug-public')
        const slugGitUrl = document.getElementById('slug-git-url')
        const slugGitBranch = document.getElementById('slug-git-branch')
        const slugGitUsername = document.getElementById('slug-git-username')
        const slugGitPassword = document.getElementById('slug-git-password')
        const newPassword = document.getElementById('newPassword')
        const newPasswordConfirm = document.getElementById('newPasswordConfirm')
        
        const me = document.getElementById('me')

        const folderClaims = document.getElementById('folderClaims')
        const folderClaimFolder = document.getElementById('folderClaim-folder')
        const folderClaimUserId = document.getElementById('folderClaim-userid')
        
        const remoteOpen = document.getElementById('remoteOpens')

        const users = document.getElementById('users')
        const usersWrapper = document.getElementById('usersWrapper')
        
        const slugPopup = document.getElementById('slugPopup')
        const folderClaimPopup = document.getElementById('folderClaimPop')

        let user_list = []
        let folderClaim_list = []
        let remoteOpen_list = []
        let slug_list = []
        let currently_editing = null
        const params = new URLSearchParams(window.location.search)
        let remoteId = params.get("remoteId");
        
        let createdRemoteOpen = null
        
        whoAmI()
        loadSlugs().then(res =>
            loadRemoteOpens())
        loadUsers()
        loadFolderClaims()

        const ac = new Awesomplete(document.getElementById("remoteChooserPath"), { minChars: 0 });

        let basePath = "-"
        function updatePaths() {
            const path = document.getElementById("remoteChooserPath").value;
            let newBasePath = path.substring(0, path.lastIndexOf("/")+1);
            if(basePath === newBasePath) return;
            basePath = newBasePath;

            fetch(`/api/v1/slugs/${currently_editing.id}/list?path=${basePath}`)
                .then(res => res.json())
                .then(paths => {
                    ac.list = paths
                    ac.evaluate()
                })
                .catch(console.error);
        }
        const slugAc = new Awesomplete(document.getElementById("slug-folder"), { minChars: 0 });
        let slugBasePath = "-"
        function updateSlugPaths() {
            const path = document.getElementById("slug-folder").value;
            let newBasePath = path.substring(0, path.lastIndexOf("/")+1);
            if(slugBasePath === newBasePath) return;
            slugBasePath = newBasePath;

            fetch(`/api/v1/slugs/dirs?path=${slugBasePath}`)
                .then(res => res.json())
                .then(paths => {
                    slugAc.list = paths
                    slugAc.evaluate()
                })
                .catch(console.error);
        }
        
        function getLink() {
            return `${getHost()}/api/v1/remotes/open/${createdRemoteOpen.id}?secret=${createdRemoteOpen.secret}`
        }
        
        function copyLink() {
            navigator.clipboard.writeText(getLink())
            alert("Copied")
        }

        function save(filename, data) {
            const blob = new Blob([data], {type: 'text/csv'});
            if(window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, filename);
            }
            else{
                const elem = window.document.createElement('a');
                elem.href = window.URL.createObjectURL(blob);
                elem.download = filename;
                document.body.appendChild(elem);
                elem.click();
                document.body.removeChild(elem);
            }
        }


        function downloadHtml() {
            save(`remoteOpen-${createdRemoteOpen.name}.html`, `<html>
<head>
<title>Remote Opener Redirector</title>
</head>
<body>
<h1>Remote Opener</h1>
<p>'${createdRemoteOpen.name}' (${createdRemoteOpen.id})</p>
<p>Redirecting you. Have fun!</p>
<p>In case automatic redirects are off, click <a href="${getLink()}">here</a></p>
\<script>
window.location.href = '${getLink()}'
<\/script>
</body>
</html>`)
        }
        
        function confirmDelete(name) {
            return confirm(`Are you sure you want to delete ${name}?`)
        }

        function getSlugUrl(slugId, absolute = true) {
            let slug = slug_list.find(elem => elem.id === slugId)
            return `${absolute ? location.href.replace(location.pathname, "") + "/" : ""}${slug.slug}/`
        }
        
        function regenerateRemoteOpen(id) {
            let remoteOpenEntry = remoteOpen_list.find(elem => elem.id === id)
            if (!remoteOpenEntry) {
                alert("Couldn't find RemoteOpen")
                return;
            }
            if(!confirm(`Do you really want to regenerate the secret of RemoteOpen '${remoteOpenEntry.name}' (${remoteOpenEntry.id})`))
                return;

            fetch(`/api/v1/remotes/regenerate/${remoteOpenEntry.id}`, {method: 'POST', headers: {"content-type": "application/json"}}).then(res => {
                if(!res.ok) {
                    error("Error regenerating RemoteOpen", res)
                    return;
                }
                res.json().then(data => {
                    createdRemoteOpen = data
                    handleRemoteOpen()
                })
            })
        }
        
        function error(msg, response) {
            response.json().then(data => {
                if(data.error) {
                    alert(`${msg}: ${data.error}`)
                }
                if(data.msg) {
                    alert(`${msg}: ${data.msg}`)
                }
            }).catch(error => {
                alert(msg)
            })
        }
        
        function deleteRemoteOpen(id) {
            let remoteOpen = remoteOpen_list.find(elem => elem.id === id)
            if (!remoteOpen) {
                alert("Couldn't find RemoteOpen")
                return;
            }
            if(!confirmDelete(`The RemoteOpen '${remoteOpen.name}' (${remoteOpen.id})`))
                return;
            
            fetch(`/api/v1/remotes/delete/${remoteOpen.id}`, {method: 'DELETE'}).then(res => {
                if(!res.ok) {
                    error("Error deleting RemoteOpen", res)
                    return;
                }
                alert("Deleted RemoteOpen");
                loadRemoteOpens()
            })
        }
        
        function showRemoteOpens() {
            let html = `<tr><th>Actions</th><th>Name</th><th>Id</th><th>Opens slug</th></tr>`
            for(const remoteOpen of remoteOpen_list) {
                html += `<tr>
<td>
<button onclick="regenerateRemoteOpen('${remoteOpen.id}')">Regenerate</button>
<button onclick="setRemoteOpen('${remoteOpen.id}', null)">Park</button>
<button onclick="deleteRemoteOpen('${remoteOpen.id}')" class="dangerous">Delete</button>
</td>
<td>${remoteOpen.name}</td>
<td>${remoteOpen.id}</td>
<td>${remoteOpen.opensSlugId ? `<a href="${getSlugUrl(remoteOpen.opensSlugId)}${remoteOpen.path ?? ""}">${getSlugUrl(remoteOpen.opensSlugId, false)}${remoteOpen.path ?? ""}</a>` : `-`}</td>
</tr>`
            }
            remoteOpen.innerHTML = html
        }

        function loadRemoteOpens() {
            fetch("/api/v1/remotes/all").then(res => {
                res.json().then(data => {
                    remoteOpen_list = data
                    showRemoteOpens()
                })
            })
        }
        
        function handleRemoteOpen() {
            openPopup('remoteOpenPopup', null)
        }
        
        function newRemoteOpen() {
            let name = prompt("Enter a display name")
            if(!name) return;
            fetch(`/api/v1/remotes/new`, {method: 'POST', headers: {"content-type": "application/json"}, body: JSON.stringify({name: name})}).then(res => {
                if(!res.ok) {
                    error("An error occurred", res)
                    return
                }
                res.json().then(data => {
                    createdRemoteOpen = data;
                    handleRemoteOpen();
                })
                loadRemoteOpens();
            })
        }
        
        function setRemoteOpen(openId, slugId) {
            fetch(`/api/v1/remotes/edit/${openId}`, {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify({opensSlugId: slugId, path: document.getElementById("remoteChooserPath").value})}).then((response) => {
                if(!response.ok){
                    error("An error occurred, check your input id", response)
                    return;
                }
                if(slugId == null) {
                    alert("RemoteOpen was parked successfully")
                } else {
                    alert("RemoteOpen was updates successfully")
                }
                loadRemoteOpens()
            })
        }

        function chooseRemoteOpen(slugId) {
            for(const s of slug_list) {
                if(s.id !== slugId) continue;
                currently_editing = s

                openPopup('remoteOpenChooserPopup', null)
                let html = "<tr><th>Action</th><th>Name</th><th>Id</th></tr>"

                if(remoteId) {
                    document.getElementById("remoteChooserId").value = remoteId;
                    remoteId = null
                    html = "<p>QR code scanned, use above!</p>"
                } else {
                    for(const o of remoteOpen_list) {
                        html += `<tr><td><button onclick="setRemoteOpen('${o.id}', '${s.id}'); closePopup('remoteOpenChooserPopup'); loadRemoteOpens();">Set</button></td><td>${o.name}</td><td>${o.id}</td></tr>`
                    }
                }
                document.getElementById("remoteOpenChooserTable").innerHTML = html
                document.getElementById("remoteOpenChooserSlugName").innerText = currently_editing.displayName
                return;
            }
            alert("Slug not found")
        }

        function saveFolderClaim() {
            const slug = {
                folderPath: folderClaimFolder.value,
                forUserId: folderClaimUserId.value,
                id: currently_editing.Id
            }
            fetch(`/api/v1/folders/${currently_editing.id}`, {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('folderClaimPopup');
                    loadFolderClaims()
                } else {
                    error("An error occurred while creating", response)
                }
            })
        }
        function createFolderClaim() {
            const slug = {
                folderPath: folderClaimFolder.value,
                forUserId: folderClaimUserId.value
            }
            fetch("/api/v1/folders", {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('folderClaimPopup');
                    loadFolderClaims()
                } else {
                    error("An error occurred while creating", response)
                }
            })
        }

        function newFolderClaim() {
            currently_editing = null
            openFolderClaimPopup()
        }

        function editFolderClaim(id) {
            for(const folderClaim of folderClaim_list) {
                if(folderClaim.id === id) {
                    currently_editing = folderClaim
                    openFolderClaimPopup()
                }
            }
        }
        
        function nameFromUserId(id) {
            if(me_data && me_data.id === id) return me_data.name
            for(const user of user_list) {
                if(user.id === id) return user.name
            }
            
            return "Unknown user"
        }
        
        function showFolderClaims() {
            let html = `<tr>${me_data && me_data.isAdmin ?`<th>Actions</th>` : ``}<th>Path</th><th>UserId</th><th>User Name</th></tr>`
            for(const folderClaim of folderClaim_list) {
                html += `<tr>
${me_data && me_data.isAdmin ? `<td>
    <button onclick="editFolderClaim('${folderClaim.id}')">Edit</button>
</td>` : ``}
<td>${folderClaim.folderPath}</td>
<td>${folderClaim.forUserId}</td>
<td>${nameFromUserId(folderClaim.forUserId)}</td>
</tr>`
            }
            folderClaims.innerHTML = html
        }
        
        function loadFolderClaims() {
            fetch("/api/v1/folders/all").then(res => {
                res.json().then(data => {
                    folderClaim_list = data
                    showFolderClaims()
                    for(const c of folderClaim_list) {
                        slugBasePath = c.folderPath
                        slugFolder.value = c.folderPath + (c.folderPath.endsWith("/") ? "" : "/")
                    }
                })
            })
        }
        
        function showUsers() {
            usersWrapper.style.display = 'block'
            let userHtml = `<tr><th>Name</th><th>Id</th><th>IsAdmin</th></tr>`
            for(const user of user_list) {
                userHtml += `<tr><td>${user.name}</td><td>${user.id}</td><td>${user.isAdmin}</td></tr>`
            }
            users.innerHTML = userHtml
        }
        
        function loadUsers() {
            fetch(`/api/v1/users/all`).then(res => {
                if (!res.ok) {
                    return
                }
                res.json().then(data => {
                    user_list = data
                    showUsers()
                    showFolderClaims()
                })
            })
        }
        
        function deleteFolderClaim() {
            if(!confirmDelete(`the folderClaim of ${nameFromUserId(currently_editing.forUserId)} (${currently_editing.forUserId}):'${currently_editing.folderPath}'?`))
                return
            fetch(`/api/v1/folders/${currently_editing.id}`, {method: "DELETE"}).then(response => {
                if(response.ok) {
                    alert("folderClaim deleted")
                    loadFolderClaims()
                    closePopup('folderClaimPopup')
                } else {
                    error("Error while deleting folderClaim", response)
                }
            })
        }
        
        function deleteSlug() {
            if(!confirmDelete(`the slug '${currently_editing.slug}':'${currently_editing.folderPath}'?`))
                return
            fetch(`/api/v1/slugs/${currently_editing.id}`, {method: "DELETE"}).then(response => {
                if(response.ok) {
                    alert("Slug deleted")
                    loadSlugs()
                    closePopup('slugPopup')
                } else {
                    error("Error while deleting slug", response)
                }
            })
        }
        
        function changePassword() {
            if(newPassword.value !== newPasswordConfirm.value) {
                alert("Passwords do not match!")
                return;
            }
            fetch(`/api/v1/slugs/${currently_editing.id}/password`, {method: 'POST', headers: {"content-type": "application/json"}, body: JSON.stringify({"password": newPassword.value})}).then(response => {
                if (response.ok) {
                    alert("Password cleared!")
                }
            })
        }
        
        function deletePassword() {
            if(!confirmDelete(`the password of ${currently_editing.slug}`))
                return
            fetch(`/api/v1/slugs/${currently_editing.id}/password`, {method: 'DELETE'}).then(response => {
                if (response.ok) {
                    alert("Password cleared!")
                }
            })
        }

        function saveSlug() {
            const slug = {
                folderPath: slugFolder.value,
                isPublic: slugPublic.checked == true,
                slug: slugName.value,
                id: currently_editing.Id
            }
            fetch(`/api/v1/slugs/${currently_editing.id}`, {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('slugPopup')
                    loadSlugs()
                } else {
                    error("An error occurred while creating", response)
                }
            })
        }
        function createSlug(e) {
            const slug = {
                folderPath: slugFolder.value,
                isPublic: slugPublic.checked == true,
                repo: currently_editing.repo == null ? null : {
                    url: slugGitUrl.value,
                    branch: slugGitBranch.value,
                    username: slugGitUsername.value,
                    password: slugGitPassword.value,
                }
            }
            let textBefore = e.innerText
            let onClickBefore = e.onclick
            e.onclick = () => {alert("Creating, hang tight...")}
            e.innerText = "Creating slug"
            fetch("/api/v1/slugs", {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                e.innerText = textBefore
                e.onclick = onClickBefore
                if(response.ok) {
                    closePopup('slugPopup')
                    loadSlugs()
                } else {
                    error("An error occurred while creating", response)
                }
            })
        }
        
        function closePopup(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function applyDisplay(className, display) {
            for(const e of document.getElementsByClassName(className)) {
                e.style.display = e.tagName.toLowerCase() === "tr" && display === "block" ? "table-row" : display;
            }
        }
        
        function openPopup(id, defaultData) {
            basePath = null
            document.getElementById(id).style.display = 'block';
            if(!currently_editing) {
                currently_editing = defaultData
                applyDisplay("whenExisting", "none")
                applyDisplay("whenNew", "block")
            } else {

                applyDisplay("whenExisting", "block")
                applyDisplay("whenNew", "none")
            }
        }
        function openFolderClaimPopup() {
            openPopup('folderClaimPopup', {folderPath: "", forUserId: "", id: null})
            folderClaimFolder.value = currently_editing.folderPath;
            folderClaimUserId.value = currently_editing.forUserId;
        }
        
        function trailingSlash(path) {
            if(!path.endsWith("/")) return path + "/";
            return path;
        }
        let createGit = false
        function openSlugPopup() {
            openPopup('slugPopup', {folderPath: trailingSlash(user_list.length > 0 || folderClaim_list.length === 0 ? "" : folderClaim_list[0].folderPath), slug: "", isPublic: false, id: null, repo: createGit ? {} : null})
            slugName.value = currently_editing.slug;
            slugFolder.value = currently_editing.folderPath;
            slugPublic.checked = currently_editing.isPublic;

            if(currently_editing.repo != null) {
                applyDisplay("whenGit", "block")
            } else {
                applyDisplay("whenGit", "none")
            }
        }
        
        function gitPull(id, e) {
            e.onclick = () => {alert("Still pulling, hang tight")}
            e.innerText = "pulling repo..."
            fetch(`/api/v1/slugs/${id}/git/pull`, {method: "POST"}).then(response => {
                if (response.ok) {
                    alert("Updated repo")
                } else {
                    error("Error updating repo", response)
                }
                loadSlugs()
            })
        }

        function updateView() {
            let filteredSlugs = slug_list
            let html = `<tr><th>Actions</th><th>Slug</th><th>Path</th><th>Public?</th><th>Password Set?</th><th>Repo</th><th>Branch</th></tr>`
            for(const slug of filteredSlugs) {
                html += `<tr>
<td>
    <button onclick="editSlug('${slug.id}')">Edit</button>
    <button onclick="chooseRemoteOpen('${slug.id}')">Remote open</button>
    <a href="/api/v1/slugs/${slug.id}/download"><button>Download</button></a>
    ${slug.repo == null ? "" : `<button onclick="gitPull('${slug.id}', this)">git pull</button>`}
    ${slug.repo == null ? "" : `<button onclick="alert('${getHost()}/api/v1/slugs/${slug.id}/git/pull')">get webhook url</button>`}
</td>
<td><a href="${getSlugUrl(slug.id)}">${slug.slug}</a></td>
<td>${slug.folderPath}</td>
<td>${slug.isPublic ? "Yes" : "No"}</td>
<td>${slug.passwordSet ? "Yes" : "No"}</td>
<td><a href="${slug.repo ? slug.repo.url : ""}">${slug.repo ? slug.repo.url : "-"}</a></td>
<td>${slug.repo ? `${slug.repo.branch}@${slug.repo.currentCommitHash}` : "-"}</td>
</tr>`
            }
            slugs.innerHTML = html
        }
        
        function newSlug(git = false) {
            currently_editing = null
            createGit = git;
            openSlugPopup()
        }
        
        function editSlug(id) {
            for(const slug of slug_list) {
                if(slug.id === id) {
                    currently_editing = slug
                    openSlugPopup()
                }
            }
        }
        
        async function loadSlugs(){
            await fetch("/api/v1/slugs/all").then(response => {
                response.json().then(data => {
                    slug_list = data
                    updateView()
                })
            })
        }
    </script>
</body>
</html>