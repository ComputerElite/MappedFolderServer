<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/assets/style.css">
    <title>Edit slugs</title>
</head>
<body>
    <h1>Me</h1>
    <div id="me">
        Loading
    </div>
    <h1>Slugs</h1>
    <table id="slugs">
        
    </table>
    <button onclick="newSlug()">New Slug</button>
    <h1>Folder Claims</h1>
    <table id="folderClaims">

    </table>
    <button onclick="newFolderClaim()" class="adminOnly hidden">New Folder Claim</button>
    <div class="hidden" id="usersWrapper">
        <h1>users</h1>
        <table id="users">

        </table>
    </div>

    <div class="popup hidden" id="folderClaimPopup">
        <div class="popup-content">
            <table>
                <tr>
                    <td>Folder path</td><td><input id="folderClaim-folder" type="text"></td>
                </tr>
                <tr>
                    <td>userid</td><td><input id="folderClaim-userid" type="text"></td>
                </tr>
                <tr>
                    <td class="whenExisting"><button onclick="saveFolderClaim()">Save</button></td>
                    <td class="whenNew"><button onclick="createFolderClaim()">Create</button></td>
                    <td><button onclick="closePopup('folderClaimPopup')">Cancel</button></td>
                </tr>
            </table>
            
            
            
            <div class="whenExisting">
                <br>
                <br>
                <tr>
                    <td>
                        <button onclick="deleteFolderClaim()" class="dangerous">Delete</button>
                    </td>
                </tr>
            </div>

        </div>
    </div>
    
    <div class="popup hidden" id="slugPopup">
        <div class="popup-content">
            <table>
                <tr class="whenExisting">
                    <td>Slug</td><td><input id="slug-name" type="text"></td>
                </tr>
                <tr>
                    <td>Folder</td><td><input id="slug-folder" type="text"></td>
                </tr>
                <tr>
                    <td>Make Public</td><td><input id="slug-public" type="checkbox"></td>
                </tr>
            </table>
            <table>
                <tr>
                    <td class="whenExisting"><button onclick="saveSlug()">Save</button></td>
                    <td class="whenNew"><button onclick="createSlug()">Create</button></td>
                    <td><button onclick="closePopup('slugPopup')">Cancel</button></td>
                </tr>
            </table>
            <div class="whenExisting">
                <br><br>
                <table>
                    <tr>
                        <td>New Password</td>
                        <td><input type="password" placeholder="new password" id="newPassword"></td>
                    </tr>
                    <tr>
                        <td>Confirm Password</td>
                        <td><input type="password" placeholder="confirm new password" id="newPasswordConfirm"></td>
                    </tr>
                    <tr>
                        <td><button onclick="changePassword()">Change password</button></td>
                        <td><button onclick="deletePassword()">Clear password</button></td>
                    </tr>
                    <tr>
                        <td>
                            <button class="dangerous" onclick="deleteSlug()">Delete</button>
                        </td>
                    </tr>
                </table>
            </div>
            
        </div>
    </div>
    <script>
        const slugs = document.getElementById('slugs')
        const slugName = document.getElementById('slug-name')
        const slugFolder = document.getElementById('slug-folder')
        const slugPublic = document.getElementById('slug-public')
        const newPassword = document.getElementById('newPassword')
        const newPasswordConfirm = document.getElementById('newPasswordConfirm')
        
        const me = document.getElementById('me')

        const folderClaims = document.getElementById('folderClaims')
        const folderClaimFolder = document.getElementById('folderClaim-folder')
        const folderClaimUserId = document.getElementById('folderClaim-userid')

        const users = document.getElementById('users')
        const usersWrapper = document.getElementById('usersWrapper')
        
        const slugPopup = document.getElementById('slugPopup')
        const folderClaimPopup = document.getElementById('folderClaimPop')

        let me_data = null
        let user_list = []
        let folderClaim_list = []
        let slug_list = []
        let currently_editing = null
        const params = new URLSearchParams(window.location.search)
        let remoteId = params.get("remoteId");
        
        whoAmI()
        loadSlugs()
        loadUsers()
        loadFolderClaims()

        function remoteOpen(slugId) {
            for(const s of slug_list) {
                if(s.id !== slugId) continue;
                if(!remoteId) remoteId = prompt("Remote id")
                fetch(`/api/v1/remote/send/${remoteId}`, {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify({opensSlugId: s.id})}).then((response) => {
                    if(!response.ok) alert("An error occurred, check your input id") 
                })
                remoteId = null
                return;
            }
            alert("Slug not found")
        }

        function saveFolderClaim() {
            const slug = {
                folderPath: folderClaimFolder.value,
                forUserId: folderClaimUserId.value,
                id: currently_editing.Id
            }
            fetch(`/api/v1/folders/${currently_editing.id}`, {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('folderClaimPopup');
                    loadFolderClaims()
                } else {
                    alert("An error occurred while creating")
                }
            })
        }
        function createFolderClaim() {
            const slug = {
                folderPath: folderClaimFolder.value,
                forUserId: folderClaimUserId.value
            }
            fetch("/api/v1/folders", {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('folderClaimPopup');
                    loadFolderClaims()
                } else {
                    alert("An error occurred while creating")

                }
            })
        }

        function newFolderClaim() {
            currently_editing = null
            openFolderClaimPopup()
        }

        function editFolderClaim(id) {
            for(const folderClaim of folderClaim_list) {
                if(folderClaim.id === id) {
                    currently_editing = folderClaim
                    openFolderClaimPopup()
                }
            }
        }
        
        function nameFromUserId(id) {
            if(me_data && me_data.id === id) return me_data.name
            for(const user of user_list) {
                if(user.id === id) return user.name
            }
            
            return "Unknown user"
        }
        
        function showFolderClaims() {
            let html = `<tr>${me_data.isAdmin ?`<th>Actions</th>` : ``}<th>Path</th><th>UserId</th><th>User Name</th></tr>`
            for(const folderClaim of folderClaim_list) {
                html += `<tr>
${me_data.isAdmin ? `<td>
    <button onclick="editFolderClaim('${folderClaim.id}')">Edit</button>
</td>` : ``}
<td>${folderClaim.folderPath}</td>
<td>${folderClaim.forUserId}</td>
<td>${nameFromUserId(folderClaim.forUserId)}</td>
</tr>`
            }
            folderClaims.innerHTML = html
        }
        
        function loadFolderClaims() {
            fetch("/api/v1/folders/all").then(res => {
                res.json().then(data => {
                    folderClaim_list = data
                    showFolderClaims()
                })
            })
        }
        
        function showUsers() {
            usersWrapper.style.display = 'block'
            let userHtml = `<tr><th>Name</th><th>Id</th><th>IsAdmin</th></tr>`
            for(const user of user_list) {
                userHtml += `<tr><td>${user.name}</td><td>${user.id}</td><td>${user.isAdmin}</td></tr>`
            }
            users.innerHTML = userHtml
        }
        
        function loadUsers() {
            fetch(`/api/v1/users/all`).then(res => {
                if (!res.ok) {
                    return
                }
                res.json().then(data => {
                    user_list = data
                    showUsers()
                    showFolderClaims()
                })
            })
        }
        
        function showMe() {
            if(!me_data) {
                me.innerHTML = `<p>You're not logged in</p>`
                return;
            }
            for(const e of document.getElementsByClassName("adminOnly")) {
                e.style.display = me_data.isAdmin ? "block" : "none"
            }

            me.innerHTML = `<p>Logged in as: ${me_data.name}<br>IsAdmin: ${me_data.isAdmin}</p>`
        }
        
        function whoAmI() {
            fetch("/api/v1/users/me/db").then(res => {
                if(!res.ok) {
                    showMe()
                    return
                }
                res.json().then(data => {
                    me_data = data
                    showMe()
                })
            })
        }
        function deleteFolderClaim() {
            if(!confirm(`Are you sure you want to delete the folderClaim of ${nameFromUserId(currently_editing.forUserId)} (${currently_editing.forUserId}):'${currently_editing.folderPath}'?`))
                return
            fetch(`/api/v1/folders/${currently_editing.id}`, {method: "DELETE"}).then(response => {
                if(response.ok) {
                    alert("folderClaim deleted")
                    loadFolderClaims()
                    closePopup('folderClaimPopup')
                } else {
                    alert("Error while deleting folderClaim")
                }
            })
        }
        
        function deleteSlug() {
            if(!confirm(`Are you sure you want to delete the slug '${currently_editing.slug}':'${currently_editing.folderPath}'?`))
                return
            fetch(`/api/v1/slugs/${currently_editing.id}`, {method: "DELETE"}).then(response => {
                if(response.ok) {
                    alert("Slug deleted")
                    loadSlugs()
                    closePopup('slugPopup')
                } else {
                    alert("Error while deleting slug")
                }
            })
        }
        
        function changePassword() {
            if(newPassword.value !== newPasswordConfirm.value) {
                alert("Passwords do not match!")
                return;
            }
            fetch(`/api/v1/slugs/${currently_editing.id}/password`, {method: 'POST', headers: {"content-type": "application/json"}, body: JSON.stringify({"password": newPassword.value})}).then(response => {
                if (response.ok) {
                    alert("Password cleared!")
                }
            })
        }
        
        function deletePassword() {
            fetch(`/api/v1/slugs/${currently_editing.id}/password`, {method: 'DELETE'}).then(response => {
                if (response.ok) {
                    alert("Password cleared!")
                }
            })
        }

        function saveSlug() {
            const slug = {
                folderPath: slugFolder.value,
                isPublic: slugPublic.checked == true,
                slug: slugName.value,
                id: currently_editing.Id
            }
            fetch(`/api/v1/slugs/${currently_editing.id}`, {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('slugPopup')
                    loadSlugs()
                } else {
                    alert("An error occurred while creating")
                }
            })
        }
        function createSlug() {
            const slug = {
                folderPath: slugFolder.value,
                isPublic: slugPublic.checked == true
            }
            fetch("/api/v1/slugs", {method: "POST", headers: {"content-type": "application/json"}, body: JSON.stringify(slug)}).then(response => {
                if(response.ok) {
                    closePopup('slugPopup')
                    loadSlugs()
                } else {
                    alert("An error occurred while creating")
                    
                }
            })
        }
        
        function closePopup(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function applyDisplay(className, display) {
            for(const e of document.getElementsByClassName(className)) {
                console.log(e.tagName)
                e.style.display = e.tagName.toLowerCase() === "tr" && display === "block" ? "table-row" : display;
            }
        }
        
        function openPopup(id, defaultData) {
            document.getElementById(id).style.display = 'block';
            if(!currently_editing) {
                currently_editing = defaultData
                applyDisplay("whenExisting", "none")
                applyDisplay("whenNew", "block")
            } else {

                applyDisplay("whenExisting", "block")
                applyDisplay("whenNew", "none")
            }
        }
        function openFolderClaimPopup() {
            openPopup('folderClaimPopup', {folderPath: "", forUserId: "", id: null})
            folderClaimFolder.value = currently_editing.folderPath;
            folderClaimUserId.value = currently_editing.forUserId;
        }
        
        function openSlugPopup() {
            openPopup('slugPopup', {folderPath: "", slug: "", isPublic: false, id: null})
            slugName.value = currently_editing.slug;
            slugFolder.value = currently_editing.folderPath;
            slugPublic.checked = currently_editing.isPublic;
        }

        function updateView() {
            let filteredSlugs = slug_list
            let html = `<tr><th>Actions</th><th>Slug</th><th>Path</th><th>Public?</th><th>Password Set?</th></tr>`
            for(const slug of filteredSlugs) {
                html += `<tr>
<td>
    <button onclick="editSlug('${slug.id}')">Edit</button>
    <button onclick="remoteOpen('${slug.id}')">Remote open</button>
</td>
<td><a href="${location.href.replace(location.pathname, "")}/${slug.slug}">${slug.slug}</a></td>
<td>${slug.folderPath}</td>
<td>${slug.isPublic ? "Yes" : "No"}</td>
<td>${slug.passwordSet ? "Yes" : "No"}</td>
</tr>`
            }
            slugs.innerHTML = html
        }
        
        function newSlug() {
            currently_editing = null
            openSlugPopup()
        }
        
        function editSlug(id) {
            for(const slug of slug_list) {
                if(slug.id === id) {
                    currently_editing = slug
                    openSlugPopup()
                }
            }
        }
        
        function loadSlugs() {
            fetch("/api/v1/slugs/all").then(response => {
                response.json().then(data => {
                    slug_list = data
                    updateView()
                })
            })
        }
    </script>
</body>
</html>