<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/assets/style.css">
    <title>Password required</title>
</head>
<body>
    <div id="ifSlug">
        <h2>Password required for <span id="name"></span> </h2>
        <label for="password">Password</label><input id="password" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>
    <div id="ifLogin" class="hidden">
        <h2>Login</h2>
    </div>
    <p id="error" class="error-box hidden">Incorrect password</p>
    <a href="/api/v1/sso/start"><button>Login with Authentik</button></a>
    
    <br><br>
    <br>
    <label for="userName">Username<input id="userName" placeholder="username"></label><br>
    <label for="userPassword">Password<input id="userPassword" type="password" placeholder="password"></label>
    <button onclick="adminLogin()">Log in with credentials</button>
    <br><br>
    <h2>Logout</h2>
    <a href="/api/v1/sso/signout"><button>Log out</button></a>
    <script>
        const password = document.getElementById("password");
        const name = document.getElementById("name");
        const error = document.getElementById("error");
        const params = new URLSearchParams(window.location.search)
        const slug = params.get("slug");
        let redirect_after = params.get("redirect_after");
        const provided_password = params.get("password");
        
        if(slug) {
            document.getElementById("ifSlug").style.display = "block";
            document.getElementById("ifLogin").style.display = "none";
        } else {
            document.getElementById("ifSlug").style.display = "none";
            document.getElementById("ifLogin").style.display = "block";
        }
        
        if(provided_password) {
            password.value = provided_password;
            login()
        }
        if(!redirect_after) {
            if(slug) {
                redirect_after = `/${slug}`
            } else {
                redirect_after = "/slugs"
            }
        }
        
        name.innerText = slug;
        
        function login() {
            error.style.display = "none";
            
            fetch(`/api/v1/authorize/${slug}`, {method: "POST", headers: {
                    "content-type": "application/json"
                }, body: JSON.stringify({"password": password.value})}).then(res => {
                if(res.ok) {
                    window.location.href = redirect_after;
                } else {
                    error.style.display = "block";
                }
            })
        }
        
        function adminLogin() {
            fetch(`/api/v1/authorize/`, {method: "POST", headers: {
                    "content-type": "application/json"
                }, body: JSON.stringify({"password": document.getElementById("userPassword").value, "username": document.getElementById("userName").value})}).then(res => {
                if(res.ok) {
                    window.location.href = redirect_after;
                } else {
                    res.json().then(res => {
                        error.innerText = res.detail;
                    })
                    error.style.display = "block";
                }
            })
        }
    </script>
</body>
</html>